echo; echo; echo "https://learn.hashicorp.com/tutorials/vault/kubernetes-sidecar?in=vault/kubernetes#inject-secrets-into-the-pod"
tee <<EOF > ./patch-inject-secrets.yaml
spec:
  template:
    metadata:
      annotations:
        vault.hashicorp.com/agent-inject: 'true'
        vault.hashicorp.com/role: 'internal-app'
        vault.hashicorp.com/agent-inject-secret-database-config.txt: 'internal/data/database/config'
EOF
export pod=$(kubectl get po -l app=orgchart -o name)

kubectl patch deployment orgchart --patch "$(cat patch-inject-secrets.yaml)"
echo "waiting for termination of $pod "  ; kubectl wait --for=delete "$pod" --timeout=2m
kubectl wait --for=condition=ready pod -l app=orgchart -n vault
kubectl get po
set +e
echo "cat /vault/secrets/database-config.txt"
kubectl exec $(kubectl get pod -l app=orgchart -o jsonpath="{.items[0].metadata.name}") --container orgchart -- cat /vault/secrets/database-config.txt
set -e
